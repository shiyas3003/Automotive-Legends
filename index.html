<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automotive Legacy Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d1117;
            --primary-text: #e6edf3;
            --secondary-text: #7d8590;
            --accent-color: #22d3ee;
            --accent-glow: rgba(34, 211, 238, 0.3);
            --border-color: rgba(255, 255, 255, 0.1);
            --card-bg: rgba(22, 27, 34, 0.6);
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text);
            background-image: radial-gradient(circle at 1px 1px, rgba(255,255,255,0.05) 1px, transparent 0);
            background-size: 2rem 2rem;
        }
        .loader {
            border: 4px solid var(--border-color);
            border-left-color: var(--accent-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .glassmorphism {
            background-color: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Tabs & Controls */
        .detail-tab { transition: all 0.2s ease; color: var(--secondary-text); border-bottom: 2px solid transparent; padding: 8px 4px; font-weight: 500;}
        .detail-tab[aria-selected="true"] { color: var(--accent-color); border-bottom-color: var(--accent-color); font-weight: 600; text-shadow: 0 0 8px var(--accent-glow); }
        .detail-tab:focus-visible { outline: 2px solid var(--accent-color); outline-offset: 2px; border-radius: 4px; }
        .detail-tab-panel[hidden] { display: none; }
        @keyframes fade-in-up { 0% { opacity: 0; transform: translateY(10px); } 100% { opacity: 1; transform: translateY(0); } }
        .fade-in-content { animation: fade-in-up 0.5s ease-out; }

        .segmented-control-btn { position: relative; flex: 1; padding: 12px; border: none; background: transparent; font-weight: 500; color: var(--secondary-text); cursor: pointer; transition: all 0.3s ease; border-bottom: 2px solid transparent; }
        .segmented-control-btn.active { color: var(--accent-color); font-weight: 600; border-bottom-color: var(--accent-color); text-shadow: 0 0 8px var(--accent-glow); }
        
        .car-list-item { transition: all 0.2s ease; border-left: 2px solid transparent; }
        .car-list-item.active { background: linear-gradient(to right, var(--card-bg), transparent); color: var(--accent-color); border-left-color: var(--accent-color); }
        
        /* Year Selector */
        .year-selector { display: flex; overflow-x: scroll; scroll-behavior: smooth; scrollbar-width: none; -ms-overflow-style: none; padding: 0.5rem 0; }
        .year-selector::-webkit-scrollbar { display: none; }
        .year-btn { flex-shrink: 0; padding: 8px 16px; font-weight: 500; color: var(--secondary-text); cursor: pointer; border-radius: 999px; transition: all 0.2s ease-in-out; border: 1px solid transparent; }
        .year-btn:hover { color: var(--primary-text); background-color: rgba(255,255,255,0.05); }
        .year-btn.active { background-color: var(--accent-color); color: var(--bg-color); font-weight: 700; box-shadow: 0 0 15px var(--accent-glow); }
        
        /* Stat Card */
        .stat-card { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1rem; text-align: center; border: 1px solid var(--border-color); }
        .stat-card .stat-label { color: var(--secondary-text); font-size: 0.9rem; margin-bottom: 0.5rem; }
        .stat-card .stat-value { color: var(--accent-color); font-size: 1.75rem; font-weight: 700; }
    </style>
</head>
<body class="min-h-screen">

    <header class="sticky top-0 z-30">
        <div class="container mx-auto px-4 py-4 text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-white tracking-wider" style="text-shadow: 0 0 10px var(--accent-glow), 0 0 20px rgba(0,0,0,0.5);">Automotive Legacy</h1>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div id="filter-controls" class="glassmorphism p-6 rounded-2xl max-w-4xl mx-auto">
            <div class="space-y-8">
                <div>
                    <h3 class="font-medium text-lg mb-3 text-center md:text-left text-gray-300">1. Select Year</h3>
                    <div id="year-selector-container" class="relative">
                        <div id="year-selector" class="year-selector"></div>
                    </div>
                </div>
                <div>
                    <h3 class="font-medium text-lg mb-3 text-center md:text-left text-gray-300">2. Choose Category</h3>
                    <div id="category-tabs-container" class="flex border-b border-[var(--border-color)]">
                        <button data-category="Road Cars" class="segmented-control-btn active">Road Cars</button>
                        <button data-category="F1" class="segmented-control-btn">F1</button>
                        <button data-category="Rally" class="segmented-control-btn">Rally</button>
                    </div>
                </div>
                <div>
                     <h3 class="font-medium text-lg mb-3 text-center md:text-left text-gray-300">3. Filter Region <span class="text-gray-500 font-normal">(Optional)</span></h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <select id="continent-filter" class="w-full px-3 py-2 bg-[var(--bg-color)] border-[var(--border-color)] border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)]"></select>
                        <select id="country-filter" class="w-full px-3 py-2 bg-[var(--bg-color)] border-[var(--border-color)] border rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)]"></select>
                     </div>
                </div>
            </div>
            <div class="mt-8 text-center">
                <button id="search-btn" class="bg-gradient-to-r from-[var(--accent-color)] to-cyan-500 text-black font-bold py-3 px-16 rounded-full hover:shadow-[0_0_20px_var(--accent-glow)] transition-all duration-300 transform hover:scale-105">Search</button>
            </div>
        </div>
        
        <div id="results-area" class="mt-12">
            </div>
    </main>

    <script>
        const searchBtn = document.getElementById('search-btn');
        const categoryTabsContainer = document.getElementById('category-tabs-container');
        const resultsArea = document.getElementById('results-area');
        const continentFilter = document.getElementById('continent-filter');
        const countryFilter = document.getElementById('country-filter');
        const yearSelector = document.getElementById('year-selector');

        let activeCategory = 'Road Cars';
        let activeYear = 1990;
        let currentCarsData = [];

        const countryData = { 'Any': ['Any'], 'Europe': ['Any', 'Germany', 'Italy', 'United Kingdom', 'France', 'Sweden'], 'Asia': ['Any', 'Japan', 'South Korea'], 'North America': ['Any', 'United States'] };

        function initializeControls() {
            populateYearSelector();
            continentFilter.innerHTML = Object.keys(countryData).map(c => `<option value="${c}">${c}</option>`).join('');
            updateCountryFilter();
            searchBtn.addEventListener('click', fetchCarData);
            continentFilter.addEventListener('change', updateCountryFilter);
            categoryTabsContainer.querySelectorAll('.segmented-control-btn').forEach(btn => btn.addEventListener('click', (e) => handleCategoryClick(e.currentTarget)));
        }
        
        function populateYearSelector() {
            const currentYear = new Date().getFullYear();
            let yearsHtml = '';
            for (let year = currentYear; year >= 1950; year--) yearsHtml += `<button class="year-btn ${year === activeYear ? 'active' : ''}" data-year="${year}">${year}</button>`;
            yearSelector.innerHTML = yearsHtml;
            yearSelector.querySelectorAll('.year-btn').forEach(btn => btn.addEventListener('click', (e) => {
                activeYear = parseInt(e.currentTarget.dataset.year, 10);
                yearSelector.querySelector('.active')?.classList.remove('active');
                e.currentTarget.classList.add('active');
            }));
            yearSelector.querySelector('.active')?.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        }

        function handleCategoryClick(target) {
            activeCategory = target.dataset.category;
            categoryTabsContainer.querySelector('.active')?.classList.remove('active');
            target.classList.add('active');
        }

        function updateCountryFilter() {
            countryFilter.innerHTML = countryData[continentFilter.value].map(country => `<option value="${country}">${country}</option>`).join('');
        }

        async function fetchCarData() {
            resultsArea.innerHTML = `<div class="flex flex-col items-center justify-center text-center py-10"><div class="loader"></div><p class="mt-4 text-slate-400">Scanning archives for influential ${activeCategory} of ${activeYear}...</p></div>`;
            try {
                const cars = await getCarInfo();
                if (!cars || !Array.isArray(cars) || cars.length === 0) throw new Error(`Could not retrieve valid car data.`);
                currentCarsData = cars;
                renderResultsLayout(cars);
            } catch (error) {
                console.error(`Error fetching data:`, error);
                showMessage(error.message || 'An unexpected error occurred.');
            }
        }

        async function getCarInfo() {
            let locationPrompt = "from anywhere in the world";
            if (countryFilter.value !== 'Any') locationPrompt = `from ${countryFilter.value}`;
            else if (continentFilter.value !== 'Any') locationPrompt = `from ${continentFilter.value}`;
            
            const prompt = `Generate a list of the top 5 most influential ${activeCategory} vehicles ${locationPrompt} for the year ${activeYear}. For each vehicle, provide its name, a short summary of its influence, a list of 3 interesting facts, a list of 4 key technical details, its approximate sales figures for that year, its total production numbers for that model year, and its original MSRP in USD. Present sales, production and MSRP as strings (e.g., "Approx. 15,000 units").`;
            
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json", responseSchema: {
                    type: "OBJECT", properties: { "cars": { type: "ARRAY", items: {
                        type: "OBJECT", properties: {
                            "name": { "type": "STRING" }, "influence": { "type": "STRING" },
                            "interesting_facts": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "technical_details": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "sales_figures": { "type": "STRING" },
                            "production_numbers": { "type": "STRING" },
                            "original_msrp": { "type": "STRING" }
                        }, required: ["name", "influence", "interesting_facts", "technical_details"]
                    }}},
                }}
            };

            const apiUrl = "https://gemini-backend-1eb3.onrender.com/generate";
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt }) });
            if (!response.ok) throw new Error(`API Error: ${response.status} ${response.statusText}`);
            const result = await response.json();
            if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                const jsonText = result.candidates[0].content.parts[0].text;
                try { return JSON.parse(jsonText).cars; } catch (e) { throw new Error("AI data was malformed. Please try again."); }
            } else { throw new Error("Failed to parse car data from the API response."); }
        }

        function getImageUrl(carName, year, type = 'photo') {
            let searchQuery = `${year} ${carName} dark moody`;
            if (type === 'diagram') searchQuery = `${carName} engine blueprint white on black`;
            const encodedQuery = encodeURIComponent(searchQuery);
            return `https://source.unsplash.com/800x600/?${encodedQuery}`;
        }

        function renderResultsLayout(cars) {
            resultsArea.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 fade-in-content">
                    <div id="car-list-container" class="lg:col-span-3 glassmorphism rounded-2xl p-4"></div>
                    <div id="car-detail-container" class="lg:col-span-9"></div>
                </div>`;
            renderCarList(cars);
            renderCarDetails(cars[0], 0);
        }

        function renderCarList(cars) {
            const listContainer = document.getElementById('car-list-container');
            const list = document.createElement('ul');
            list.className = 'space-y-2';
            cars.forEach((car, index) => {
                const listItem = document.createElement('li');
                listItem.className = `car-list-item p-3 rounded-lg cursor-pointer font-medium text-gray-300 hover:text-white ${index === 0 ? 'active' : ''}`;
                listItem.textContent = car.name;
                listItem.dataset.index = index;
                list.appendChild(listItem);
            });
            listContainer.innerHTML = ''; listContainer.appendChild(list);
            listContainer.querySelectorAll('.car-list-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.dataset.index, 10);
                    listContainer.querySelector('.active')?.classList.remove('active');
                    e.currentTarget.classList.add('active');
                    renderCarDetails(cars[index], index);
                });
            });
        }
        
        function parseNumericValue(str) {
            if (!str) return 0;
            const cleaned = str.replace(/[$,~a-zA-Z]/g, '').trim();
            return parseInt(cleaned, 10) || 0;
        }

        function renderCarDetails(car) {
            const detailContainer = document.getElementById('car-detail-container');
            if (!car) { detailContainer.innerHTML = `<p class="text-center text-gray-500">Select a car to see details.</p>`; return; }
            const year = activeYear;
            const imageUrl = getImageUrl(car.name, year, 'photo');
            const diagramUrl = getImageUrl(car.name, year, 'diagram');

            const salesNum = parseNumericValue(car.sales_figures);
            const prodNum = parseNumericValue(car.production_numbers);
            const msrpNum = parseNumericValue(car.original_msrp);

            detailContainer.innerHTML = `
                <div class="glassmorphism p-6 rounded-2xl fade-in-content">
                    <h2 class="text-3xl md:text-4xl font-bold text-white mb-2">${car.name} <span class="text-gray-400 font-normal">(${year})</span></h2>
                    <p class="text-gray-400 mb-6 max-w-3xl">${car.influence}</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="stat-card">
                            <div class="stat-label">Sales (${year})</div>
                            <div class="stat-value"><span class="counter" data-target="${salesNum}">${salesNum > 0 ? '0' : 'N/A'}</span></div>
                        </div>
                        <div class="stat-card">
                             <div class="stat-label">Production Units</div>
                             <div class="stat-value"><span class="counter" data-target="${prodNum}">${prodNum > 0 ? '0' : 'N/A'}</span></div>
                        </div>
                        <div class="stat-card">
                             <div class="stat-label">Original MSRP</div>
                             <div class="stat-value">$<span class="counter" data-target="${msrpNum}">${msrpNum > 0 ? '0' : 'N/A'}</span></div>
                        </div>
                    </div>

                    <div class="relative rounded-lg shadow-lg w-full h-64 md:h-96 bg-black/20 mb-8 border border-[var(--border-color)]">
                        <img src="${imageUrl}" class="w-full h-full object-cover rounded-lg" alt="Photo of ${car.name}">
                    </div>
                    
                    <div id="detail-tabs">
                        <div role="tablist" class="flex space-x-6 border-b border-[var(--border-color)] mb-4">
                            <button role="tab" aria-selected="true" aria-controls="panel-facts" class="detail-tab">Facts</button>
                            <button role="tab" aria-selected="false" aria-controls="panel-tech" tabindex="-1" class="detail-tab">Tech Specs</button>
                            <button role="tab" aria-selected="false" aria-controls="panel-diagram" tabindex="-1" class="detail-tab">Diagram</button>
                        </div>
                        <div id="panel-facts" role="tabpanel" class="detail-tab-panel fade-in-content"><ul class="list-disc list-inside text-gray-300 space-y-2">${car.interesting_facts.map(fact => `<li>${fact}</li>`).join('')}</ul></div>
                        <div id="panel-tech" role="tabpanel" class="detail-tab-panel" hidden><ul class="space-y-2 text-gray-300">${car.technical_details.map(detail => `<li class="flex items-center border-b border-[var(--border-color)] py-2"><strong class="w-1/3 text-gray-400">${detail.split(':')[0]}:</strong><span>${detail.split(':').slice(1).join(':').trim()}</span></li>`).join('')}</ul></div>
                        <div id="panel-diagram" role="tabpanel" class="detail-tab-panel" hidden><div class="relative rounded-lg w-full h-96 bg-black/20 border border-[var(--border-color)]"><img src="${diagramUrl}" class="w-full h-full object-contain rounded-lg p-2" alt="${car.name} parts diagram"></div></div>
                    </div>
                </div>`;
            initializeAccessibleTabs(document.getElementById('detail-tabs'));
            initializeCounters();
        }
        
        function initializeCounters() {
            const counters = document.querySelectorAll('.counter');
            const observer = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const counter = entry.target;
                        const target = +counter.getAttribute('data-target');
                        if (target === 0) return;
                        
                        let current = 0;
                        const increment = target / 100;

                        const updateCounter = () => {
                            if (current < target) {
                                current += increment;
                                counter.innerText = Math.ceil(current).toLocaleString();
                                requestAnimationFrame(updateCounter);
                            } else {
                                counter.innerText = target.toLocaleString();
                            }
                        };
                        updateCounter();
                        observer.unobserve(counter);
                    }
                });
            }, { threshold: 0.5 });

            counters.forEach(counter => observer.observe(counter));
        }

        function initializeAccessibleTabs(tabContainer) {
            const tabs = Array.from(tabContainer.querySelectorAll('[role="tab"]'));
            tabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const currentTab = e.currentTarget;
                    const panelId = currentTab.getAttribute('aria-controls');
                    tabs.forEach(t => { t.setAttribute('aria-selected', 'false'); t.setAttribute('tabindex', '-1'); });
                    currentTab.setAttribute('aria-selected', 'true');
                    currentTab.removeAttribute('tabindex');
                    Array.from(tabContainer.querySelectorAll('[role="tabpanel"]')).forEach(p => {
                        p.hidden = (p.id !== panelId);
                        p.classList.remove('fade-in-content');
                        if(p.id === panelId) p.classList.add('fade-in-content');
                    });
                });
            });
        }

        function showMessage(msg) {
            resultsArea.innerHTML = `<div class="glassmorphism max-w-md mx-auto text-red-400 p-6 rounded-lg text-center"><h3 class="font-bold text-lg mb-2">An Error Occurred</h3><p>${msg}</p></div>`;
        }

        initializeControls();
    </script>
</body>
</html>
